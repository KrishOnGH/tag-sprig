const playerOneRunningRight = ">"
const playerOneRunningLeft = "<"
const playerOneIdle = ":"
const playerTwoRunningRight = "("
const playerTwoRunningLeft = ")"
const playerTwoIdle = "*"
const tagged = "!"

setLegend(
  [ playerOneRunningRight, bitmap`
................
.....0000000....
....0.......0...
...0..3..3..0...
...0..3..3..0...
...0........0...
...0........0...
....0......0....
.....0....0.....
.....0....0.....
.....0....0.....
....0......0....
...0...00...0...
..0...0..0..0...
...000....0.0...
...........0....` ],
  [ playerOneRunningLeft, bitmap`
................
....0000000.....
...0.......0....
...0..3..3..0...
...0..3..3..0...
...0........0...
...0........0...
....0......0....
.....0....0.....
.....0....0.....
.....0....0.....
....0......0....
...0...00...0...
...0..0..0...0..
...0.0....000...
....0...........` ],
  [ playerOneIdle, bitmap`
................
.....0000000....
....0.......0...
...0..3...3..0..
...0..3...3..0..
...0.........0..
...0.........0..
....0.......0...
.....0.....0....
.....0.....0....
.....0.....0....
.....0.....0....
.....0.....0....
.....0..0..0....
.....0.0.0.0....
.....00..00.....` ],
  [ playerTwoRunningRight, bitmap`
................
.....0000000....
....0.......0...
...0..5..5..0...
...0..5..5..0...
...0........0...
...0........0...
....0......0....
.....0....0.....
.....0....0.....
.....0....0.....
....0......0....
...0...00...0...
..0...0..0..0...
...000....0.0...
...........0....` ],
  [ playerTwoRunningLeft, bitmap`
................
....0000000.....
...0.......0....
...0..5..5..0...
...0..5..5..0...
...0........0...
...0........0...
....0......0....
.....0....0.....
.....0....0.....
.....0....0.....
....0......0....
...0...00...0...
...0..0..0...0..
...0.0....000...
....0...........` ],
  [ playerTwoIdle, bitmap`
................
.....0000000....
....0.......0...
...0..5...5..0..
...0..5...5..0..
...0.........0..
...0.........0..
....0.......0...
.....0.....0....
.....0.....0....
.....0.....0....
.....0.....0....
.....0.....0....
.....0..0..0....
.....0.0.0.0....
.....00..00.....` ],
  [ tagged, bitmap`
................
................
................
................
................
................
................
................
................
...0........0...
...00......00...
....00....00....
.....00..00.....
......0000......
.......00.......
................` ],
)

setSolids([])

let level = 0
const levels = [
  map`
..............
..............
..............
..............
..............
...!..........
...:......*...
..............
..............
..............
..............`
]
setMap(levels[level])

function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

function getSprite(x, y) {
  if (getTile(x, y).length == 0) {
    return '.'
  }
  return getTile(x, y)[0]['_type']
}

for (let x = 0; x <= 14; x++) {
  for (let y = 0; y <= 10; y++) {
    console.log(getSprite(x, y))
  }
}

let it = 1
let playerOne = playerOneIdle
let playerTwo = playerTwoIdle

onInput("w", () => {
  if (it == 1) {
    getFirst(tagged).y -= 1
  }
  if (getFirst(playerOne).y > 2 || it != 1) {
    getFirst(playerOne).y -= 1
  }
})

onInput("a", () => {
  let x = getFirst(playerOne).x
  let y = getFirst(playerOne).y
  playerOne = playerOneRunningLeft
  clearTile(x, y)
  addSprite(x, y, '<')
  
  if (it == 1) {
    getFirst(tagged).x -= 1
  }
  getFirst(playerOne).x -= 1
})

onInput("d", () => {
  let x = getFirst(playerOne).x
  let y = getFirst(playerOne).y
  playerOne = playerOneRunningRight
  clearTile(x, y)
  addSprite(x, y, '>')
  
  if (it == 1) {
    getFirst(tagged).x += 1
  }
  getFirst(playerOne).x += 1
})

onInput("i", () => {
  if (it == 2) {
    getFirst(tagged).y -= 1
  }
  if (getFirst(playerTwo).y > 2 || it != 2) {
    getFirst(playerTwo).y -= 1
  }
})

onInput("j", () => {
  let x = getFirst(playerTwo).x
  let y = getFirst(playerTwo).y
  playerTwo = playerTwoRunningLeft
  clearTile(x, y)
  addSprite(x, y, ')')
  
  if (it == 2) {
    getFirst(tagged).x -= 1
  }
  getFirst(playerTwo).x -= 1
})

onInput("l", () => {
  let x = getFirst(playerTwo).x
  let y = getFirst(playerTwo).y
  playerTwo = playerTwoRunningRight
  clearTile(x, y)
  addSprite(x, y, '(')
  
  if (it == 2) {
    getFirst(tagged).x += 1
  }
  getFirst(playerTwo).x += 1
})

afterInput(async () => {
  await delay(400);
  let x = getFirst(playerOne).x
  let y = getFirst(playerOne).y
  playerOne = playerOneIdle
  clearTile(x, y)
  addSprite(x, y, ':')
  
  x = getFirst(playerTwo).x
  y = getFirst(playerTwo).y
  playerTwo = playerTwoIdle
  clearTile(x, y)
  addSprite(x, y, '*')
  
  async function applyGravityWithDelay(sprite) {
    let x = getFirst(sprite).x
    let y = getFirst(sprite).y

    for (let i = y; i <= 10; i++) {
      if (i < 10 && getSprite(x, i+1) == '.') {
        getFirst(sprite).y += 1
        await delay(100)
      } else {
        break
      }
    }
  }
  
  await applyGravityWithDelay(playerOne);

  await applyGravityWithDelay(playerTwo);

  await applyGravityWithDelay(tagged);
})